# 设计模式应用

## 1. 设计模式概述

在如意订单系统中，广泛应用了多种设计模式来解决复杂的业务问题，提高代码的可维护性、可扩展性和可复用性。本文档详细分析系统中应用的各种设计模式。

### 1.1 设计模式分类

#### 1.1.1 创建型模式
- **建造者模式（Builder）**：用于构建复杂的订单对象
- **工厂方法模式（Factory Method）**：用于创建不同类型的订单处理器
- **单例模式（Singleton）**：用于全局配置管理

#### 1.1.2 结构型模式
- **适配器模式（Adapter）**：用于适配不同的支付接口
- **装饰器模式（Decorator）**：用于订单处理流程的功能增强
- **外观模式（Facade）**：用于简化复杂的子系统调用

#### 1.1.3 行为型模式
- **策略模式（Strategy）**：用于不同的价格计算策略
- **观察者模式（Observer）**：用于订单状态变化通知
- **责任链模式（Chain of Responsibility）**：用于订单验证流程
- **状态模式（State）**：用于订单状态管理
- **模板方法模式（Template Method）**：用于订单处理流程

## 2. 建造者模式（Builder Pattern）

### 2.1 应用场景
订单系统中，订单对象包含大量属性，使用建造者模式可以优雅地构建复杂的订单对象。

### 2.2 实现分析

#### 2.2.1 订单建造者
```java
public class NewOrderBuilder {
    
    // 订单基本信息
    private String orderId;
    private String userId;
    private Integer orderType;
    private Integer orderStatus;
    
    // 订单金额信息
    private Integer totalAmount;
    private Integer payAmount;
    private Integer discountAmount;
    
    // 订单条目信息
    private List<OrderItemRequest> orderItems;
    
    // 配送信息
    private OrderDeliveryRequest deliveryInfo;
    
    // 支付信息
    private List<OrderPaymentRequest> paymentInfo;
    
    public NewOrderBuilder orderId(String orderId) {
        this.orderId = orderId;
        return this;
    }
    
    public NewOrderBuilder userId(String userId) {
        this.userId = userId;
        return this;
    }
    
    public NewOrderBuilder orderType(Integer orderType) {
        this.orderType = orderType;
        return this;
    }
    
    public NewOrderBuilder orderStatus(Integer orderStatus) {
        this.orderStatus = orderStatus;
        return this;
    }
    
    public NewOrderBuilder totalAmount(Integer totalAmount) {
        this.totalAmount = totalAmount;
        return this;
    }
    
    public NewOrderBuilder payAmount(Integer payAmount) {
        this.payAmount = payAmount;
        return this;
    }
    
    public NewOrderBuilder discountAmount(Integer discountAmount) {
        this.discountAmount = discountAmount;
        return this;
    }
    
    public NewOrderBuilder orderItems(List<OrderItemRequest> orderItems) {
        this.orderItems = orderItems;
        return this;
    }
    
    public NewOrderBuilder deliveryInfo(OrderDeliveryRequest deliveryInfo) {
        this.deliveryInfo = deliveryInfo;
        return this;
    }
    
    public NewOrderBuilder paymentInfo(List<OrderPaymentRequest> paymentInfo) {
        this.paymentInfo = paymentInfo;
        return this;
    }
    
    /**
     * 构建完整的订单数据
     */
    public FullOrderData build() {
        // 参数校验
        validateParameters();
        
        // 构建主订单
        OrderInfoDO orderInfo = buildOrderInfo();
        
        // 构建订单条目
        List<OrderItemDO> orderItemList = buildOrderItems();
        
        // 构建订单金额
        List<OrderAmountDO> orderAmountList = buildOrderAmounts();
        
        // 构建订单金额明细
        List<OrderAmountDetailDO> orderAmountDetailList = buildOrderAmountDetails();
        
        // 构建配送信息
        OrderDeliveryDetailDO deliveryDetail = buildDeliveryDetail();
        
        // 构建支付信息
        List<OrderPaymentDetailDO> paymentDetailList = buildPaymentDetails();
        
        // 构建订单快照
        List<OrderSnapshotDO> snapshotList = buildOrderSnapshots();
        
        // 构建操作日志
        OrderOperateLogDO operateLog = buildOperateLog();
        
        // 组装完整订单数据
        FullOrderData fullOrderData = new FullOrderData();
        fullOrderData.setOrderInfoDO(orderInfo);
        fullOrderData.setOrderItemDOList(orderItemList);
        fullOrderData.setOrderAmountDOList(orderAmountList);
        fullOrderData.setOrderAmountDetailDOList(orderAmountDetailList);
        fullOrderData.setOrderDeliveryDetailDO(deliveryDetail);
        fullOrderData.setOrderPaymentDetailDOList(paymentDetailList);
        fullOrderData.setOrderSnapshotDOList(snapshotList);
        fullOrderData.setOrderOperateLogDO(operateLog);
        
        return fullOrderData;
    }
    
    private void validateParameters() {
        if (StringUtils.isEmpty(orderId)) {
            throw new IllegalArgumentException("订单ID不能为空");
        }
        if (StringUtils.isEmpty(userId)) {
            throw new IllegalArgumentException("用户ID不能为空");
        }
        if (orderItems == null || orderItems.isEmpty()) {
            throw new IllegalArgumentException("订单条目不能为空");
        }
        if (totalAmount == null || totalAmount <= 0) {
            throw new IllegalArgumentException("订单总金额必须大于0");
        }
        if (payAmount == null || payAmount < 0) {
            throw new IllegalArgumentException("订单实付金额不能为负数");
        }
    }
    
    private OrderInfoDO buildOrderInfo() {
        OrderInfoDO orderInfo = new OrderInfoDO();
        orderInfo.setOrderId(orderId);
        orderInfo.setUserId(userId);
        orderInfo.setOrderType(orderType);
        orderInfo.setOrderStatus(orderStatus != null ? orderStatus : OrderStatusEnum.CREATED.getCode());
        orderInfo.setTotalAmount(totalAmount);
        orderInfo.setPayAmount(payAmount);
        orderInfo.setDiscountAmount(discountAmount != null ? discountAmount : 0);
        orderInfo.setGmtCreate(new Date());
        orderInfo.setGmtModified(new Date());
        
        // 设置支付超时时间
        Date expireTime = new Date(System.currentTimeMillis() + 30 * 60 * 1000); // 30分钟后过期
        orderInfo.setExpireTime(expireTime);
        
        return orderInfo;
    }
    
    private List<OrderItemDO> buildOrderItems() {
        List<OrderItemDO> orderItemList = new ArrayList<>();
        
        for (OrderItemRequest itemRequest : orderItems) {
            OrderItemDO orderItem = new OrderItemDO();
            orderItem.setOrderId(orderId);
            orderItem.setOrderItemId(generateOrderItemId());
            orderItem.setProductId(itemRequest.getProductId());
            orderItem.setSkuCode(itemRequest.getSkuCode());
            orderItem.setProductName(itemRequest.getProductName());
            orderItem.setSaleQuantity(itemRequest.getQuantity());
            orderItem.setSalePrice(itemRequest.getSalePrice());
            orderItem.setOriginAmount(itemRequest.getOriginAmount());
            orderItem.setPayAmount(itemRequest.getPayAmount());
            orderItem.setProductType(itemRequest.getProductType());
            orderItem.setGmtCreate(new Date());
            orderItem.setGmtModified(new Date());
            
            orderItemList.add(orderItem);
        }
        
        return orderItemList;
    }
    
    private List<OrderAmountDO> buildOrderAmounts() {
        List<OrderAmountDO> orderAmountList = new ArrayList<>();
        
        // 商品金额
        OrderAmountDO productAmount = new OrderAmountDO();
        productAmount.setOrderId(orderId);
        productAmount.setAmountType(AmountTypeEnum.PRODUCT_AMOUNT.getCode());
        productAmount.setAmount(totalAmount);
        orderAmountList.add(productAmount);
        
        // 运费金额
        if (deliveryInfo != null && deliveryInfo.getDeliveryAmount() != null) {
            OrderAmountDO deliveryAmount = new OrderAmountDO();
            deliveryAmount.setOrderId(orderId);
            deliveryAmount.setAmountType(AmountTypeEnum.DELIVERY_AMOUNT.getCode());
            deliveryAmount.setAmount(deliveryInfo.getDeliveryAmount());
            orderAmountList.add(deliveryAmount);
        }
        
        // 优惠金额
        if (discountAmount != null && discountAmount > 0) {
            OrderAmountDO discountAmountDO = new OrderAmountDO();
            discountAmountDO.setOrderId(orderId);
            discountAmountDO.setAmountType(AmountTypeEnum.DISCOUNT_AMOUNT.getCode());
            discountAmountDO.setAmount(discountAmount);
            orderAmountList.add(discountAmountDO);
        }
        
        return orderAmountList;
    }
    
    // ... 其他构建方法
    
    private String generateOrderItemId() {
        return orderId + "_" + System.currentTimeMillis() + "_" + new Random().nextInt(1000);
    }
}
```

#### 2.2.2 建造者使用示例
```java
@Service
public class OrderBuildService {
    
    public FullOrderData buildNewOrder(CreateOrderRequest request) {
        return new NewOrderBuilder()
                .orderId(request.getOrderId())
                .userId(request.getUserId())
                .orderType(request.getOrderType())
                .totalAmount(request.getTotalAmount())
                .payAmount(request.getPayAmount())
                .discountAmount(request.getDiscountAmount())
                .orderItems(request.getOrderItemRequestList())
                .deliveryInfo(request.getOrderDeliveryRequest())
                .paymentInfo(request.getPaymentRequestList())
                .build();
    }
}
```

### 2.3 设计优势

1. **参数校验集中**：在build()方法中统一进行参数校验
2. **构建过程清晰**：每个步骤职责明确，易于理解和维护
3. **灵活性高**：可以根据不同场景选择性设置参数
4. **代码复用**：不同类型的订单可以复用相同的构建逻辑

## 3. 策略模式（Strategy Pattern）

### 3.1 应用场景
订单系统中存在多种价格计算策略，如普通订单、促销订单、会员订单等，使用策略模式可以灵活切换不同的计算逻辑。

### 3.2 实现分析

#### 3.2.1 价格计算策略接口
```java
public interface PriceCalculationStrategy {
    
    /**
     * 计算订单价格
     * @param request 计算请求
     * @return 计算结果
     */
    CalculateOrderAmountDTO calculate(CalculateOrderAmountRequest request);
    
    /**
     * 获取策略类型
     * @return 策略类型
     */
    OrderTypeEnum getOrderType();
    
    /**
     * 策略优先级
     * @return 优先级，数值越小优先级越高
     */
    default int getPriority() {
        return 100;
    }
}
```

#### 3.2.2 普通订单价格策略
```java
@Component
public class NormalOrderPriceStrategy implements PriceCalculationStrategy {
    
    @Autowired
    private ProductService productService;
    
    @Autowired
    private MarketService marketService;
    
    @Override
    public CalculateOrderAmountDTO calculate(CalculateOrderAmountRequest request) {
        List<OrderItemRequest> orderItems = request.getOrderItemRequestList();
        String couponId = request.getCouponId();
        
        // 1. 计算商品总金额
        Integer totalProductAmount = calculateProductAmount(orderItems);
        
        // 2. 计算运费
        Integer deliveryAmount = calculateDeliveryAmount(request);
        
        // 3. 计算优惠券抵扣
        Integer couponDiscountAmount = calculateCouponDiscount(couponId, totalProductAmount);
        
        // 4. 计算实付金额
        Integer realPayAmount = totalProductAmount + deliveryAmount - couponDiscountAmount;
        
        // 5. 构建返回结果
        CalculateOrderAmountDTO result = new CalculateOrderAmountDTO();
        result.setTotalAmount(totalProductAmount);
        result.setDeliveryAmount(deliveryAmount);
        result.setCouponDiscountAmount(couponDiscountAmount);
        result.setRealPayAmount(realPayAmount);
        
        // 6. 构建金额明细
        List<OrderAmountDTO> orderAmountList = buildOrderAmountList(
                totalProductAmount, deliveryAmount, couponDiscountAmount);
        result.setOrderAmountList(orderAmountList);
        
        return result;
    }
    
    @Override
    public OrderTypeEnum getOrderType() {
        return OrderTypeEnum.NORMAL;
    }
    
    private Integer calculateProductAmount(List<OrderItemRequest> orderItems) {
        return orderItems.stream()
                .mapToInt(item -> item.getSalePrice() * item.getQuantity())
                .sum();
    }
    
    private Integer calculateDeliveryAmount(CalculateOrderAmountRequest request) {
        // 普通订单运费计算逻辑
        Integer totalAmount = calculateProductAmount(request.getOrderItemRequestList());
        
        // 满99免运费
        if (totalAmount >= 9900) {
            return 0;
        }
        
        return 800; // 8元运费
    }
    
    private Integer calculateCouponDiscount(String couponId, Integer totalAmount) {
        if (StringUtils.isEmpty(couponId)) {
            return 0;
        }
        
        // 获取优惠券信息
        UserCouponDTO coupon = marketService.getUserCoupon(couponId);
        if (coupon == null) {
            return 0;
        }
        
        // 检查使用条件
        if (totalAmount < coupon.getConditionAmount()) {
            return 0;
        }
        
        // 计算抵扣金额
        if (coupon.getCouponType() == CouponTypeEnum.AMOUNT.getCode()) {
            // 满减券
            return Math.min(coupon.getDiscountAmount(), totalAmount);
        } else if (coupon.getCouponType() == CouponTypeEnum.RATE.getCode()) {
            // 折扣券
            Integer discountAmount = totalAmount * coupon.getDiscountRate() / 100;
            return Math.min(discountAmount, coupon.getMaxDiscountAmount());
        }
        
        return 0;
    }
    
    private List<OrderAmountDTO> buildOrderAmountList(Integer totalAmount, 
                                                     Integer deliveryAmount, 
                                                     Integer couponDiscountAmount) {
        List<OrderAmountDTO> orderAmountList = new ArrayList<>();
        
        // 商品金额
        OrderAmountDTO productAmountDTO = new OrderAmountDTO();
        productAmountDTO.setAmountType(AmountTypeEnum.PRODUCT_AMOUNT.getCode());
        productAmountDTO.setAmount(totalAmount);
        orderAmountList.add(productAmountDTO);
        
        // 运费
        if (deliveryAmount > 0) {
            OrderAmountDTO deliveryAmountDTO = new OrderAmountDTO();
            deliveryAmountDTO.setAmountType(AmountTypeEnum.DELIVERY_AMOUNT.getCode());
            deliveryAmountDTO.setAmount(deliveryAmount);
            orderAmountList.add(deliveryAmountDTO);
        }
        
        // 优惠券抵扣
        if (couponDiscountAmount > 0) {
            OrderAmountDTO discountAmountDTO = new OrderAmountDTO();
            discountAmountDTO.setAmountType(AmountTypeEnum.COUPON_DISCOUNT_AMOUNT.getCode());
            discountAmountDTO.setAmount(-couponDiscountAmount); // 负数表示抵扣
            orderAmountList.add(discountAmountDTO);
        }
        
        return orderAmountList;
    }
}
```

#### 3.2.3 会员订单价格策略
```java
@Component
public class VipOrderPriceStrategy implements PriceCalculationStrategy {
    
    @Autowired
    private UserService userService;
    
    @Override
    public CalculateOrderAmountDTO calculate(CalculateOrderAmountRequest request) {
        // 会员订单价格计算逻辑
        String userId = request.getUserId();
        
        // 检查会员等级
        UserInfoDTO userInfo = userService.getUserInfo(userId);
        VipLevelEnum vipLevel = VipLevelEnum.getByCode(userInfo.getVipLevel());
        
        // 基础价格计算
        CalculateOrderAmountDTO baseResult = calculateBaseAmount(request);
        
        // 会员折扣
        Integer vipDiscountAmount = calculateVipDiscount(baseResult.getTotalAmount(), vipLevel);
        
        // 会员免运费
        Integer deliveryAmount = 0; // 会员免运费
        
        // 重新计算实付金额
        Integer realPayAmount = baseResult.getTotalAmount() + deliveryAmount 
                              - baseResult.getCouponDiscountAmount() - vipDiscountAmount;
        
        // 构建结果
        CalculateOrderAmountDTO result = new CalculateOrderAmountDTO();
        result.setTotalAmount(baseResult.getTotalAmount());
        result.setDeliveryAmount(deliveryAmount);
        result.setCouponDiscountAmount(baseResult.getCouponDiscountAmount());
        result.setVipDiscountAmount(vipDiscountAmount);
        result.setRealPayAmount(realPayAmount);
        
        return result;
    }
    
    @Override
    public OrderTypeEnum getOrderType() {
        return OrderTypeEnum.VIP;
    }
    
    @Override
    public int getPriority() {
        return 10; // 高优先级
    }
    
    private Integer calculateVipDiscount(Integer totalAmount, VipLevelEnum vipLevel) {
        switch (vipLevel) {
            case GOLD:
                return totalAmount * 5 / 100; // 95折
            case PLATINUM:
                return totalAmount * 8 / 100; // 92折
            case DIAMOND:
                return totalAmount * 10 / 100; // 90折
            default:
                return 0;
        }
    }
}
```

#### 3.2.4 策略工厂
```java
@Component
public class PriceCalculationStrategyFactory {
    
    private final Map<OrderTypeEnum, PriceCalculationStrategy> strategyMap;
    
    public PriceCalculationStrategyFactory(List<PriceCalculationStrategy> strategies) {
        this.strategyMap = strategies.stream()
                .collect(Collectors.toMap(
                        PriceCalculationStrategy::getOrderType,
                        strategy -> strategy,
                        (existing, replacement) -> {
                            // 如果有重复，选择优先级高的
                            return existing.getPriority() <= replacement.getPriority() 
                                   ? existing : replacement;
                        }
                ));
    }
    
    public PriceCalculationStrategy getStrategy(OrderTypeEnum orderType) {
        PriceCalculationStrategy strategy = strategyMap.get(orderType);
        if (strategy == null) {
            // 默认使用普通订单策略
            strategy = strategyMap.get(OrderTypeEnum.NORMAL);
        }
        return strategy;
    }
    
    public List<PriceCalculationStrategy> getAllStrategies() {
        return new ArrayList<>(strategyMap.values());
    }
}
```

#### 3.2.5 策略使用示例
```java
@Service
public class OrderPriceService {
    
    @Autowired
    private PriceCalculationStrategyFactory strategyFactory;
    
    public CalculateOrderAmountDTO calculateOrderAmount(CalculateOrderAmountRequest request) {
        OrderTypeEnum orderType = OrderTypeEnum.getByCode(request.getOrderType());
        
        // 获取对应的价格计算策略
        PriceCalculationStrategy strategy = strategyFactory.getStrategy(orderType);
        
        // 执行价格计算
        CalculateOrderAmountDTO result = strategy.calculate(request);
        
        log.info("订单价格计算完成, orderType: {}, strategy: {}, totalAmount: {}", 
                 orderType, strategy.getClass().getSimpleName(), result.getTotalAmount());
        
        return result;
    }
}
```

## 4. 观察者模式（Observer Pattern）

### 4.1 应用场景
订单状态变化时需要通知多个子系统，如库存系统、营销系统、通知系统等，使用观察者模式可以实现松耦合的事件通知。

### 4.2 实现分析

#### 4.2.1 订单事件定义
```java
public class OrderStatusChangedEvent extends ApplicationEvent {
    
    private final String orderId;
    private final Integer fromStatus;
    private final Integer toStatus;
    private final String userId;
    private final Date changeTime;
    private final String remark;
    
    public OrderStatusChangedEvent(Object source, String orderId, Integer fromStatus, 
                                  Integer toStatus, String userId, String remark) {
        super(source);
        this.orderId = orderId;
        this.fromStatus = fromStatus;
        this.toStatus = toStatus;
        this.userId = userId;
        this.changeTime = new Date();
        this.remark = remark;
    }
    
    // getters...
}

public class OrderCreatedEvent extends ApplicationEvent {
    
    private final OrderInfoDO orderInfo;
    private final List<OrderItemDO> orderItems;
    private final Date createTime;
    
    public OrderCreatedEvent(Object source, OrderInfoDO orderInfo, List<OrderItemDO> orderItems) {
        super(source);
        this.orderInfo = orderInfo;
        this.orderItems = orderItems;
        this.createTime = new Date();
    }
    
    // getters...
}

public class OrderPaidEvent extends ApplicationEvent {
    
    private final String orderId;
    private final String userId;
    private final Integer payAmount;
    private final Date payTime;
    
    public OrderPaidEvent(Object source, String orderId, String userId, Integer payAmount) {
        super(source);
        this.orderId = orderId;
        this.userId = userId;
        this.payAmount = payAmount;
        this.payTime = new Date();
    }
    
    // getters...
}
```

#### 4.2.2 事件发布者
```java
@Service
public class OrderEventPublisher {
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    /**
     * 发布订单状态变更事件
     */
    public void publishOrderStatusChanged(String orderId, Integer fromStatus, 
                                        Integer toStatus, String userId, String remark) {
        OrderStatusChangedEvent event = new OrderStatusChangedEvent(
                this, orderId, fromStatus, toStatus, userId, remark);
        
        eventPublisher.publishEvent(event);
        
        log.info("发布订单状态变更事件, orderId: {}, {} -> {}", orderId, fromStatus, toStatus);
    }
    
    /**
     * 发布订单创建事件
     */
    public void publishOrderCreated(OrderInfoDO orderInfo, List<OrderItemDO> orderItems) {
        OrderCreatedEvent event = new OrderCreatedEvent(this, orderInfo, orderItems);
        
        eventPublisher.publishEvent(event);
        
        log.info("发布订单创建事件, orderId: {}", orderInfo.getOrderId());
    }
    
    /**
     * 发布订单支付事件
     */
    public void publishOrderPaid(String orderId, String userId, Integer payAmount) {
        OrderPaidEvent event = new OrderPaidEvent(this, orderId, userId, payAmount);
        
        eventPublisher.publishEvent(event);
        
        log.info("发布订单支付事件, orderId: {}, payAmount: {}", orderId, payAmount);
    }
}
```

#### 4.2.3 事件监听器

**库存同步监听器**
```java
@Component
public class InventorySyncEventListener {
    
    @Autowired
    private InventoryService inventoryService;
    
    @EventListener
    @Async
    public void handleOrderCreated(OrderCreatedEvent event) {
        try {
            OrderInfoDO orderInfo = event.getOrderInfo();
            List<OrderItemDO> orderItems = event.getOrderItems();
            
            log.info("处理订单创建库存同步事件, orderId: {}", orderInfo.getOrderId());
            
            // 同步库存扣减信息
            for (OrderItemDO orderItem : orderItems) {
                InventorySyncRequest syncRequest = new InventorySyncRequest();
                syncRequest.setOrderId(orderInfo.getOrderId());
                syncRequest.setSkuCode(orderItem.getSkuCode());
                syncRequest.setQuantity(orderItem.getSaleQuantity());
                syncRequest.setOperationType(InventoryOperationTypeEnum.DEDUCT.getCode());
                
                inventoryService.syncInventoryChange(syncRequest);
            }
            
        } catch (Exception e) {
            log.error("处理订单创建库存同步事件失败, orderId: {}", 
                     event.getOrderInfo().getOrderId(), e);
        }
    }
    
    @EventListener
    @Async
    public void handleOrderStatusChanged(OrderStatusChangedEvent event) {
        try {
            String orderId = event.getOrderId();
            Integer toStatus = event.getToStatus();
            
            // 订单取消时释放库存
            if (OrderStatusEnum.CANCELED.getCode().equals(toStatus)) {
                log.info("处理订单取消库存释放事件, orderId: {}", orderId);
                inventoryService.releaseOrderInventory(orderId);
            }
            
        } catch (Exception e) {
            log.error("处理订单状态变更库存事件失败, orderId: {}", event.getOrderId(), e);
        }
    }
}
```

**营销活动监听器**
```java
@Component
public class MarketingEventListener {
    
    @Autowired
    private MarketService marketService;
    
    @Autowired
    private UserService userService;
    
    @EventListener
    @Async
    public void handleOrderPaid(OrderPaidEvent event) {
        try {
            String orderId = event.getOrderId();
            String userId = event.getUserId();
            Integer payAmount = event.getPayAmount();
            
            log.info("处理订单支付营销事件, orderId: {}, userId: {}", orderId, userId);
            
            // 1. 更新用户积分
            updateUserPoints(userId, payAmount);
            
            // 2. 检查升级条件
            checkUserLevelUpgrade(userId);
            
            // 3. 发放支付奖励
            givePaymentReward(userId, payAmount);
            
            // 4. 触发推荐奖励
            triggerReferralReward(userId, payAmount);
            
        } catch (Exception e) {
            log.error("处理订单支付营销事件失败, orderId: {}", event.getOrderId(), e);
        }
    }
    
    private void updateUserPoints(String userId, Integer payAmount) {
        // 每消费1元获得1积分
        Integer points = payAmount / 100;
        if (points > 0) {
            userService.addUserPoints(userId, points);
            log.info("用户积分更新, userId: {}, points: +{}", userId, points);
        }
    }
    
    private void checkUserLevelUpgrade(String userId) {
        // 检查用户等级升级条件
        UserInfoDTO userInfo = userService.getUserInfo(userId);
        VipLevelEnum currentLevel = VipLevelEnum.getByCode(userInfo.getVipLevel());
        
        // 根据消费金额和积分判断是否可以升级
        boolean canUpgrade = marketService.checkVipUpgradeCondition(userId);
        if (canUpgrade) {
            VipLevelEnum newLevel = getNextVipLevel(currentLevel);
            userService.upgradeUserVipLevel(userId, newLevel.getCode());
            log.info("用户等级升级, userId: {}, {} -> {}", userId, currentLevel, newLevel);
        }
    }
    
    private void givePaymentReward(String userId, Integer payAmount) {
        // 支付满额奖励
        if (payAmount >= 10000) { // 满100元
            // 发放优惠券
            marketService.giveCouponToUser(userId, "PAYMENT_REWARD_COUPON");
            log.info("发放支付奖励优惠券, userId: {}, payAmount: {}", userId, payAmount);
        }
    }
}
```

**通知服务监听器**
```java
@Component
public class NotificationEventListener {
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private SmsService smsService;
    
    @Autowired
    private EmailService emailService;
    
    @EventListener
    @Async
    public void handleOrderStatusChanged(OrderStatusChangedEvent event) {
        try {
            String orderId = event.getOrderId();
            String userId = event.getUserId();
            Integer toStatus = event.getToStatus();
            
            log.info("处理订单状态变更通知事件, orderId: {}, status: {}", orderId, toStatus);
            
            // 根据状态发送不同的通知
            switch (OrderStatusEnum.getByCode(toStatus)) {
                case CREATED:
                    sendOrderCreatedNotification(orderId, userId);
                    break;
                case PAID:
                    sendOrderPaidNotification(orderId, userId);
                    break;
                case FULFILL:
                    sendOrderFulfillNotification(orderId, userId);
                    break;
                case OUT_STOCK:
                    sendOrderShippedNotification(orderId, userId);
                    break;
                case DELIVERY:
                    sendOrderDeliveryNotification(orderId, userId);
                    break;
                case SIGNED:
                    sendOrderSignedNotification(orderId, userId);
                    break;
                case CANCELED:
                    sendOrderCanceledNotification(orderId, userId);
                    break;
                default:
                    break;
            }
            
        } catch (Exception e) {
            log.error("处理订单状态变更通知事件失败, orderId: {}", event.getOrderId(), e);
        }
    }
    
    private void sendOrderCreatedNotification(String orderId, String userId) {
        // 发送订单创建通知
        NotificationRequest notification = new NotificationRequest();
        notification.setUserId(userId);
        notification.setTitle("订单创建成功");
        notification.setContent("您的订单" + orderId + "已创建成功，请及时支付");
        notification.setType(NotificationTypeEnum.ORDER_CREATED.getCode());
        
        notificationService.sendNotification(notification);
    }
    
    private void sendOrderPaidNotification(String orderId, String userId) {
        // 发送支付成功通知
        NotificationRequest notification = new NotificationRequest();
        notification.setUserId(userId);
        notification.setTitle("支付成功");
        notification.setContent("您的订单" + orderId + "支付成功，我们将尽快为您发货");
        notification.setType(NotificationTypeEnum.ORDER_PAID.getCode());
        
        notificationService.sendNotification(notification);
        
        // 发送短信通知
        SmsRequest smsRequest = new SmsRequest();
        smsRequest.setUserId(userId);
        smsRequest.setTemplate("ORDER_PAID_SMS");
        smsRequest.addParam("orderId", orderId);
        
        smsService.sendSms(smsRequest);
    }
    
    private void sendOrderShippedNotification(String orderId, String userId) {
        // 发送发货通知
        NotificationRequest notification = new NotificationRequest();
        notification.setUserId(userId);
        notification.setTitle("订单已发货");
        notification.setContent("您的订单" + orderId + "已发货，请注意查收");
        notification.setType(NotificationTypeEnum.ORDER_SHIPPED.getCode());
        
        notificationService.sendNotification(notification);
        
        // 发送邮件通知
        EmailRequest emailRequest = new EmailRequest();
        emailRequest.setUserId(userId);
        emailRequest.setSubject("订单发货通知");
        emailRequest.setTemplate("ORDER_SHIPPED_EMAIL");
        emailRequest.addParam("orderId", orderId);
        
        emailService.sendEmail(emailRequest);
    }
}
```

## 5. 责任链模式（Chain of Responsibility Pattern）

### 5.1 应用场景
订单创建时需要进行多层校验，如参数校验、风控校验、库存校验、优惠券校验等，使用责任链模式可以灵活组织校验流程。

### 5.2 实现分析

#### 5.2.1 校验处理器接口
```java
public abstract class OrderValidationHandler {
    
    protected OrderValidationHandler nextHandler;
    
    public void setNext(OrderValidationHandler nextHandler) {
        this.nextHandler = nextHandler;
    }
    
    public final void handle(CreateOrderRequest request) {
        // 执行当前处理器的校验
        doValidate(request);
        
        // 如果有下一个处理器，继续处理
        if (nextHandler != null) {
            nextHandler.handle(request);
        }
    }
    
    /**
     * 具体的校验逻辑
     */
    protected abstract void doValidate(CreateOrderRequest request);
    
    /**
     * 获取处理器名称
     */
    public abstract String getHandlerName();
    
    /**
     * 获取处理器优先级
     */
    public int getPriority() {
        return 100;
    }
}
```

#### 5.2.2 具体校验处理器

**基础参数校验**
```java
@Component
public class BasicParameterValidationHandler extends OrderValidationHandler {
    
    @Override
    protected void doValidate(CreateOrderRequest request) {
        log.info("执行基础参数校验, orderId: {}", request.getOrderId());
        
        // 订单ID校验
        if (StringUtils.isEmpty(request.getOrderId())) {
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_ID_IS_NULL);
        }
        
        // 用户ID校验
        if (StringUtils.isEmpty(request.getUserId())) {
            throw new OrderBizException(OrderErrorCodeEnum.USER_ID_IS_NULL);
        }
        
        // 业务标识符校验
        if (BusinessIdentifierEnum.getByCode(request.getBusinessIdentifier()) == null) {
            throw new OrderBizException(OrderErrorCodeEnum.BUSINESS_IDENTIFIER_ERROR);
        }
        
        // 订单类型校验
        if (OrderTypeEnum.getByCode(request.getOrderType()) == null) {
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_TYPE_ERROR);
        }
        
        // 订单条目校验
        List<OrderItemRequest> orderItems = request.getOrderItemRequestList();
        if (orderItems == null || orderItems.isEmpty()) {
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_ITEMS_IS_NULL);
        }
        
        for (OrderItemRequest item : orderItems) {
            validateOrderItem(item);
        }
        
        // 配送信息校验
        validateDeliveryInfo(request.getOrderDeliveryRequest());
        
        // 支付信息校验
        validatePaymentInfo(request.getPaymentRequestList());
        
        log.info("基础参数校验通过, orderId: {}", request.getOrderId());
    }
    
    private void validateOrderItem(OrderItemRequest item) {
        if (StringUtils.isEmpty(item.getProductId())) {
            throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_ID_IS_NULL);
        }
        
        if (StringUtils.isEmpty(item.getSkuCode())) {
            throw new OrderBizException(OrderErrorCodeEnum.SKU_CODE_IS_NULL);
        }
        
        if (item.getQuantity() == null || item.getQuantity() <= 0) {
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_ITEM_QUANTITY_ERROR);
        }
        
        if (item.getSalePrice() == null || item.getSalePrice() <= 0) {
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_ITEM_PRICE_ERROR);
        }
    }
    
    private void validateDeliveryInfo(OrderDeliveryRequest deliveryInfo) {
        if (deliveryInfo == null) {
            throw new OrderBizException(OrderErrorCodeEnum.DELIVERY_INFO_IS_NULL);
        }
        
        if (StringUtils.isEmpty(deliveryInfo.getProvince())) {
            throw new OrderBizException(OrderErrorCodeEnum.DELIVERY_PROVINCE_IS_NULL);
        }
        
        if (StringUtils.isEmpty(deliveryInfo.getReceiverName())) {
            throw new OrderBizException(OrderErrorCodeEnum.RECEIVER_NAME_IS_NULL);
        }
        
        if (StringUtils.isEmpty(deliveryInfo.getReceiverPhone())) {
            throw new OrderBizException(OrderErrorCodeEnum.RECEIVER_PHONE_IS_NULL);
        }
    }
    
    private void validatePaymentInfo(List<OrderPaymentRequest> paymentInfo) {
        if (paymentInfo == null || paymentInfo.isEmpty()) {
            throw new OrderBizException(OrderErrorCodeEnum.PAYMENT_INFO_IS_NULL);
        }
        
        for (OrderPaymentRequest payment : paymentInfo) {
            if (PayTypeEnum.getByCode(payment.getPayType()) == null) {
                throw new OrderBizException(OrderErrorCodeEnum.PAY_TYPE_ERROR);
            }
            
            if (payment.getPayAmount() == null || payment.getPayAmount() <= 0) {
                throw new OrderBizException(OrderErrorCodeEnum.PAY_AMOUNT_ERROR);
            }
        }
    }
    
    @Override
    public String getHandlerName() {
        return "基础参数校验";
    }
    
    @Override
    public int getPriority() {
        return 10; // 最高优先级
    }
}
```

**风控校验处理器**
```java
@Component
public class RiskControlValidationHandler extends OrderValidationHandler {
    
    @Autowired
    private RiskApi riskApi;
    
    @Override
    protected void doValidate(CreateOrderRequest request) {
        log.info("执行风控校验, orderId: {}, userId: {}", request.getOrderId(), request.getUserId());
        
        CheckOrderRiskRequest riskRequest = new CheckOrderRiskRequest();
        riskRequest.setOrderId(request.getOrderId());
        riskRequest.setUserId(request.getUserId());
        riskRequest.setClientIp(request.getClientIp());
        riskRequest.setOrderAmount(request.getTotalAmount());
        riskRequest.setOrderItems(request.getOrderItemRequestList());
        
        JsonResult<CheckOrderRiskDTO> riskResult = riskApi.checkOrderRisk(riskRequest);
        
        if (!riskResult.getSuccess()) {
            log.warn("风控校验失败, orderId: {}, error: {}", 
                     request.getOrderId(), riskResult.getErrorMessage());
            throw new OrderBizException(riskResult.getErrorCode(), riskResult.getErrorMessage());
        }
        
        CheckOrderRiskDTO riskData = riskResult.getData();
        if (!riskData.getPassRisk()) {
            log.warn("风控校验不通过, orderId: {}, riskLevel: {}, reason: {}", 
                     request.getOrderId(), riskData.getRiskLevel(), riskData.getRiskReason());
            throw new OrderBizException(OrderErrorCodeEnum.ORDER_RISK_CHECK_FAILED, riskData.getRiskReason());
        }
        
        log.info("风控校验通过, orderId: {}", request.getOrderId());
    }
    
    @Override
    public String getHandlerName() {
        return "风控校验";
    }
    
    @Override
    public int getPriority() {
        return 20;
    }
}
```

**商品信息校验处理器**
```java
@Component
public class ProductValidationHandler extends OrderValidationHandler {
    
    @Autowired
    private ProductApi productApi;
    
    @Override
    protected void doValidate(CreateOrderRequest request) {
        log.info("执行商品信息校验, orderId: {}", request.getOrderId());
        
        List<OrderItemRequest> orderItems = request.getOrderItemRequestList();
        List<String> skuCodes = orderItems.stream()
                .map(OrderItemRequest::getSkuCode)
                .collect(Collectors.toList());
        
        // 批量获取商品信息
        ListSkuInfoRequest skuRequest = new ListSkuInfoRequest();
        skuRequest.setSkuCodeList(skuCodes);
        
        JsonResult<List<ProductSkuDTO>> skuResult = productApi.listSkuInfo(skuRequest);
        if (!skuResult.getSuccess() || skuResult.getData() == null) {
            throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_INFO_ERROR);
        }
        
        List<ProductSkuDTO> skuList = skuResult.getData();
        Map<String, ProductSkuDTO> skuMap = skuList.stream()
                .collect(Collectors.toMap(ProductSkuDTO::getSkuCode, sku -> sku));
        
        // 校验每个商品
        for (OrderItemRequest item : orderItems) {
            ProductSkuDTO sku = skuMap.get(item.getSkuCode());
            
            if (sku == null) {
                throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_NOT_FOUND, 
                                           "商品不存在: " + item.getSkuCode());
            }
            
            // 校验商品状态
            if (!ProductStatusEnum.NORMAL.getCode().equals(sku.getProductStatus())) {
                throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_STATUS_ERROR, 
                                           "商品状态异常: " + item.getSkuCode());
            }
            
            // 校验商品价格
            if (!item.getSalePrice().equals(sku.getSalePrice())) {
                throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_PRICE_CHANGED, 
                                           "商品价格已变更: " + item.getSkuCode());
            }
            
            // 校验商品库存
            if (sku.getAvailableStock() < item.getQuantity()) {
                throw new OrderBizException(OrderErrorCodeEnum.PRODUCT_STOCK_NOT_ENOUGH, 
                                           "商品库存不足: " + item.getSkuCode());
            }
        }
        
        log.info("商品信息校验通过, orderId: {}", request.getOrderId());
    }
    
    @Override
    public String getHandlerName() {
        return "商品信息校验";
    }
    
    @Override
    public int getPriority() {
        return 30;
    }
}
```

**优惠券校验处理器**
```java
@Component
public class CouponValidationHandler extends OrderValidationHandler {
    
    @Autowired
    private MarketApi marketApi;
    
    @Override
    protected void doValidate(CreateOrderRequest request) {
        String couponId = request.getCouponId();
        
        // 如果没有使用优惠券，跳过校验
        if (StringUtils.isEmpty(couponId)) {
            log.info("未使用优惠券，跳过优惠券校验, orderId: {}", request.getOrderId());
            return;
        }
        
        log.info("执行优惠券校验, orderId: {}, couponId: {}", request.getOrderId(), couponId);
        
        // 获取优惠券信息
        GetUserCouponRequest couponRequest = new GetUserCouponRequest();
        couponRequest.setUserId(request.getUserId());
        couponRequest.setCouponId(couponId);
        
        JsonResult<UserCouponDTO> couponResult = marketApi.getUserCoupon(couponRequest);
        if (!couponResult.getSuccess() || couponResult.getData() == null) {
            throw new OrderBizException(OrderErrorCodeEnum.COUPON_NOT_FOUND);
        }
        
        UserCouponDTO coupon = couponResult.getData();
        
        // 校验优惠券状态
        if (!CouponStatusEnum.AVAILABLE.getCode().equals(coupon.getStatus())) {
            throw new OrderBizException(OrderErrorCodeEnum.COUPON_STATUS_ERROR);
        }
        
        // 校验优惠券有效期
        Date now = new Date();
        if (now.before(coupon.getStartTime()) || now.after(coupon.getEndTime())) {
            throw new OrderBizException(OrderErrorCodeEnum.COUPON_EXPIRED);
        }
        
        // 校验使用条件
        Integer orderAmount = request.getTotalAmount();
        if (orderAmount < coupon.getConditionAmount()) {
            throw new OrderBizException(OrderErrorCodeEnum.COUPON_CONDITION_NOT_MET);
        }
        
        // 校验商品适用范围
        if (!checkCouponProductScope(coupon, request.getOrderItemRequestList())) {
            throw new OrderBizException(OrderErrorCodeEnum.COUPON_PRODUCT_NOT_APPLICABLE);
        }
        
        log.info("优惠券校验通过, orderId: {}, couponId: {}", request.getOrderId(), couponId);
    }
    
    private boolean checkCouponProductScope(UserCouponDTO coupon, List<OrderItemRequest> orderItems) {
        // 如果是全品类优惠券，直接返回true
        if (CouponScopeEnum.ALL.getCode().equals(coupon.getScopeType())) {
            return true;
        }
        
        // 如果是指定品类优惠券，检查商品品类
        if (CouponScopeEnum.CATEGORY.getCode().equals(coupon.getScopeType())) {
            Set<String> applicableCategories = coupon.getApplicableCategories();
            return orderItems.stream()
                    .anyMatch(item -> applicableCategories.contains(item.getCategoryId()));
        }
        
        // 如果是指定商品优惠券，检查商品ID
        if (CouponScopeEnum.PRODUCT.getCode().equals(coupon.getScopeType())) {
            Set<String> applicableProducts = coupon.getApplicableProducts();
            return orderItems.stream()
                    .anyMatch(item -> applicableProducts.contains(item.getProductId()));
        }
        
        return false;
    }
    
    @Override
    public String getHandlerName() {
        return "优惠券校验";
    }
    
    @Override
    public int getPriority() {
        return 40;
    }
}
```

#### 5.2.3 责任链构建器
```java
@Component
public class OrderValidationChainBuilder {
    
    private final List<OrderValidationHandler> handlers;
    
    public OrderValidationChainBuilder(List<OrderValidationHandler> handlers) {
        // 按优先级排序
        this.handlers = handlers.stream()
                .sorted(Comparator.comparingInt(OrderValidationHandler::getPriority))
                .collect(Collectors.toList());
    }
    
    /**
     * 构建校验责任链
     */
    public OrderValidationHandler buildChain() {
        if (handlers.isEmpty()) {
            throw new IllegalStateException("没有可用的校验处理器");
        }
        
        OrderValidationHandler firstHandler = handlers.get(0);
        OrderValidationHandler currentHandler = firstHandler;
        
        for (int i = 1; i < handlers.size(); i++) {
            OrderValidationHandler nextHandler = handlers.get(i);
            currentHandler.setNext(nextHandler);
            currentHandler = nextHandler;
        }
        
        log.info("构建订单校验责任链完成, 处理器数量: {}", handlers.size());
        for (OrderValidationHandler handler : handlers) {
            log.info("- {}: 优先级{}", handler.getHandlerName(), handler.getPriority());
        }
        
        return firstHandler;
    }
    
    /**
     * 构建自定义责任链
     */
    public OrderValidationHandler buildCustomChain(List<Class<? extends OrderValidationHandler>> handlerClasses) {
        List<OrderValidationHandler> customHandlers = handlers.stream()
                .filter(handler -> handlerClasses.contains(handler.getClass()))
                .sorted(Comparator.comparingInt(OrderValidationHandler::getPriority))
                .collect(Collectors.toList());
        
        if (customHandlers.isEmpty()) {
            throw new IllegalArgumentException("没有找到指定的校验处理器");
        }
        
        OrderValidationHandler firstHandler = customHandlers.get(0);
        OrderValidationHandler currentHandler = firstHandler;
        
        for (int i = 1; i < customHandlers.size(); i++) {
            OrderValidationHandler nextHandler = customHandlers.get(i);
            currentHandler.setNext(nextHandler);
            currentHandler = nextHandler;
        }
        
        return firstHandler;
    }
}
```

#### 5.2.4 责任链使用示例
```java
@Service
public class OrderValidationService {
    
    @Autowired
    private OrderValidationChainBuilder chainBuilder;
    
    /**
     * 执行完整的订单校验
     */
    public void validateOrder(CreateOrderRequest request) {
        log.info("开始执行订单校验, orderId: {}", request.getOrderId());
        
        long startTime = System.currentTimeMillis();
        
        try {
            // 构建校验责任链
            OrderValidationHandler validationChain = chainBuilder.buildChain();
            
            // 执行校验
            validationChain.handle(request);
            
            long endTime = System.currentTimeMillis();
            log.info("订单校验完成, orderId: {}, 耗时: {}ms", 
                     request.getOrderId(), endTime - startTime);
            
        } catch (Exception e) {
            long endTime = System.currentTimeMillis();
            log.error("订单校验失败, orderId: {}, 耗时: {}ms", 
                     request.getOrderId(), endTime - startTime, e);
            throw e;
        }
    }
    
    /**
     * 执行快速校验（跳过部分校验）
     */
    public void validateOrderQuickly(CreateOrderRequest request) {
        log.info("开始执行订单快速校验, orderId: {}", request.getOrderId());
        
        // 只执行基础参数校验和商品校验
        List<Class<? extends OrderValidationHandler>> quickHandlers = Arrays.asList(
                BasicParameterValidationHandler.class,
                ProductValidationHandler.class
        );
        
        OrderValidationHandler validationChain = chainBuilder.buildCustomChain(quickHandlers);
        validationChain.handle(request);
        
        log.info("订单快速校验完成, orderId: {}", request.getOrderId());
    }
}
```

## 6. 总结

### 6.1 设计模式应用总结

通过在如意订单系统中应用多种设计模式，实现了以下目标：

#### 6.1.1 代码质量提升
- **可维护性**：通过策略模式和责任链模式，使代码更容易维护和扩展
- **可读性**：建造者模式使复杂对象的构建过程更清晰
- **可测试性**：各个模式都有清晰的接口定义，便于单元测试

#### 6.1.2 系统架构优化
- **松耦合**：观察者模式实现了系统间的松耦合
- **高内聚**：每个模式都专注于解决特定的问题
- **易扩展**：新功能可以通过实现相应的接口来扩展

#### 6.1.3 业务逻辑清晰
- **职责分离**：每个类都有明确的职责
- **流程清晰**：责任链模式使业务流程更加清晰
- **策略灵活**：策略模式使业务规则更加灵活

### 6.2 最佳实践

1. **合理选择设计模式**：根据实际业务需求选择合适的设计模式
2. **避免过度设计**：不要为了使用设计模式而使用，要解决实际问题
3. **保持简单性**：在满足需求的前提下，保持代码的简单性
4. **文档完善**：为设计模式的应用编写清晰的文档
5. **团队共识**：确保团队成员都理解所使用的设计模式

### 6.3 注意事项

1. **性能考虑**：某些设计模式可能会带来性能开销，需要权衡
2. **复杂度控制**：避免过度使用设计模式导致系统复杂度过高
3. **版本兼容**：设计模式的应用要考虑系统的版本兼容性
4. **监控告警**：对关键的设计模式应用进行监控和告警

通过合理应用设计模式，如意订单系统实现了高质量、高可维护性的代码架构，为系统的长期发展奠定了坚实的基础。
